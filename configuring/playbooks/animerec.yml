- name: Checkout animerec repo
  hosts: cluster
  tasks:
    - ansible.builtin.git:
        repo: 'https://github.com/barraponto/animerec.git'
        dest: ~/animerec
        version: main

- name: Build animerec docker image for minikube
  hosts: cluster
  tasks:
    - ansible.builtin.shell:
        cmd: |
          eval $(minikube -p minikube docker-env) && \
          docker build . -t animerec:latest
        chdir: ~/animerec

- name: Configure animerec-secrets
  hosts: cluster
  vars:
    secrets:
      GROQ_API_KEY: "{{ lookup('env', 'GROQ_API_KEY') | default('') }}"
      HUGGINGFACE_API_TOKEN: "{{ lookup('env', 'HUGGINGFACE_API_TOKEN') | default('') }}"
  tasks:
    - name: Check if environment variables are set
      ansible.builtin.assert:
        that:
          - secrets.GROQ_API_KEY != ''
          - secrets.HUGGINGFACE_API_TOKEN != ''
        fail_msg: "Required environment variables GROQ_API_KEY and HUGGINGFACE_API_TOKEN must be set"
        success_msg: "All required environment variables are set"

    - name: Create or update animerec-secrets
      ansible.builtin.shell: |
        minikube kubectl -- create secret generic animerec-secrets \
        --from-literal=GROQ_API_KEY="{{ secrets.GROQ_API_KEY }}" \
        --from-literal=HUGGINGFACE_API_TOKEN="{{ secrets.HUGGINGFACE_API_TOKEN }}" \
        --dry-run=client -o yaml | minikube kubectl -- apply -f -
      register: secret_result
      changed_when: "'created' in secret_result.stdout or 'configured' in secret_result.stdout or 'secret/animerec-secrets created' in secret_result.stdout"

- name: Deploy animerec
  hosts: cluster
  tasks:
    - name: Deploy animerec-server
      ansible.builtin.command:
        cmd: minikube kubectl -- apply -f app.k8s.yaml
        chdir: ~/animerec
      register: animerec_server_result
      changed_when: "'created' in animerec_server_result.stdout or 'configured' in animerec_server_result.stdout or 'deployment/animerec-server created' in animerec_server_result.stdout"
