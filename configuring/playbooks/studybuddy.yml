- name: Configure studybuddy-secrets
  hosts: cluster
  vars:
    secrets:
      GROQ_API_KEY: "{{ lookup('env', 'GROQ_API_KEY') | default('') }}"
  tasks:
    - name: Check if environment variables are set
      ansible.builtin.assert:
        that:
          - secrets.GROQ_API_KEY != ''
        fail_msg: "Required environment variables GROQ_API_KEY must be set"
        success_msg: "All required environment variables are set"

    - name: Create or update studybuddy-secrets
      ansible.builtin.shell: |
        minikube kubectl -- create secret generic studybuddy-secrets \
        --from-literal=GROQ_API_KEY="{{ secrets.GROQ_API_KEY }}" \
        --namespace=argocd \
        --dry-run=client -o yaml | minikube kubectl -- apply -f -
      register: secret_result
      changed_when: "'created' in secret_result.stdout or 'configured' in secret_result.stdout or 'secret/studybuddy-secrets created' in secret_result.stdout"
