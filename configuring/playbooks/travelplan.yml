- name: Checkout travelplan repo
  hosts: cluster
  tasks:
    - ansible.builtin.git:
        repo: 'https://github.com/barraponto/travelplan.git'
        dest: ~/travelplan
        version: main

- name: Build travelplan docker image for minikube
  hosts: cluster
  tasks:
    - ansible.builtin.shell:
        cmd: |
          eval $(minikube -p minikube docker-env) && \
          docker build . -t travelplan:latest
        chdir: ~/travelplan

- name: Configure travelplan-secrets
  hosts: cluster
  vars:
    secrets:
      GROQ_API_KEY: "{{ lookup('env', 'GROQ_API_KEY') | default('') }}"
  tasks:
    - name: Check if environment variables are set
      ansible.builtin.assert:
        that:
          - secrets.GROQ_API_KEY != ''
        fail_msg: "Required environment variables GROQ_API_KEY must be set"
        success_msg: "All required environment variables are set"

    - name: Create or update travelplan-secrets
      ansible.builtin.shell: |
        minikube kubectl -- create secret generic travelplan-secrets \
        --from-literal=GROQ_API_KEY="{{ secrets.GROQ_API_KEY }}" \
        --dry-run=client -o yaml | minikube kubectl -- apply -f -
      register: secret_result
      changed_when: "'created' in secret_result.stdout or 'configured' in secret_result.stdout or 'secret/travelplan-secrets created' in secret_result.stdout"

- name: Deploy travelplan
  hosts: cluster
  tasks:
    - name: Deploy travelplan-server
      ansible.builtin.command:
        cmd: minikube kubectl -- apply -f deploy.k8s.yml
        chdir: ~/travelplan
      register: travelplan_server_result
      changed_when: "'created' in travelplan_server_result.stdout or 'configured' in travelplan_server_result.stdout or 'deployment/travelplan-server created' in travelplan_server_result.stdout"
